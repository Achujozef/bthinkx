{% extends 'base.html' %}
{% load static %}

{% block title %}My Attendance - BThinkX{% endblock %}

{% block extra_css %}
<style>
    .attendance-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .attendance-title {
        font-size: 32px;
        font-weight: 800;
        font-family: 'Space Grotesk', sans-serif;
        background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .attendance-controls {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-group {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .filter-select {
        padding: 10px 16px;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        color: var(--text-primary);
        font-family: 'Inter', sans-serif;
        cursor: pointer;
        transition: var(--transition);
        font-size: 14px;
        font-weight: 500;
    }

    .filter-select:hover {
        border-color: var(--accent-green);
        background: rgba(16, 185, 129, 0.1);
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--accent-green);
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
    }

    /* Summary Cards */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .summary-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        transition: var(--transition);
    }

    .summary-card:hover {
        border-color: var(--accent-green);
        background: rgba(16, 185, 129, 0.05);
    }

    .summary-card-icon {
        font-size: 28px;
    }

    .summary-card-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    .summary-card-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .summary-card-detail {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 8px;
    }

    /* Toggle Buttons */
    .toggle-view {
        display: flex;
        gap: 8px;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 4px;
    }

    .toggle-btn {
        padding: 8px 16px;
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-weight: 600;
        cursor: pointer;
        border-radius: 6px;
        transition: var(--transition);
        font-size: 13px;
    }

    .toggle-btn.active {
        background: var(--accent-green);
        color: white;
    }

    .toggle-btn:hover:not(.active) {
        color: var(--text-primary);
    }

    /* Attendance Table */
    .attendance-table-container {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 32px;
    }

    .attendance-table {
        width: 100%;
        border-collapse: collapse;
    }

    .attendance-table thead {
        background: rgba(139, 92, 246, 0.1);
        border-bottom: 2px solid var(--card-border);
    }

    .attendance-table th {
        padding: 16px;
        text-align: left;
        font-size: 12px;
        font-weight: 700;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .attendance-table tbody tr {
        border-bottom: 1px solid var(--card-border);
        transition: var(--transition);
    }

    .attendance-table tbody tr:hover {
        background: rgba(139, 92, 246, 0.05);
    }

    .attendance-table td {
        padding: 16px;
        color: var(--text-primary);
        font-size: 14px;
    }

    .date-cell {
        font-weight: 600;
        color: var(--accent-green);
    }

    .time-cell {
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 13px;
        color: var(--text-secondary);
    }

    .status-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        text-transform: capitalize;
    }

    .status-badge.present {
        background: rgba(16, 185, 129, 0.1);
        color: var(--accent-green);
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-badge.absent {
        background: rgba(239, 68, 68, 0.1);
        color: var(--accent-red);
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .status-badge.half_day {
        background: rgba(245, 158, 11, 0.1);
        color: var(--accent-yellow);
        border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .status-badge.leave {
        background: rgba(139, 92, 246, 0.1);
        color: var(--accent-purple);
        border: 1px solid rgba(139, 92, 246, 0.3);
    }

    .hours-badge {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent-blue);
        border: 1px solid rgba(59, 130, 246, 0.3);
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }

    /* Calendar View */
    .calendar-container {
        display: none;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 24px;
    }

    .calendar-container.active {
        display: block;
    }

    .calendar {
        width: 100%;
        border-collapse: collapse;
    }

    .calendar thead th {
        padding: 12px;
        text-align: center;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-size: 11px;
        border-bottom: 2px solid var(--card-border);
    }

    .calendar tbody td {
        padding: 12px;
        text-align: center;
        border: 1px solid var(--card-border);
        min-height: 60px;
        vertical-align: top;
        position: relative;
    }

    .calendar tbody td:hover {
        background: rgba(139, 92, 246, 0.05);
    }

    .calendar-day-number {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        display: block;
        margin-bottom: 4px;
    }

    .calendar-day-indicator {
        font-size: 11px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 3px;
        display: inline-block;
        margin-top: 4px;
    }

    .calendar-day-indicator.present {
        background: rgba(16, 185, 129, 0.2);
        color: var(--accent-green);
    }

    .calendar-day-indicator.absent {
        background: rgba(239, 68, 68, 0.2);
        color: var(--accent-red);
    }

    .calendar-day-indicator.half {
        background: rgba(245, 158, 11, 0.2);
        color: var(--accent-yellow);
    }

    .calendar-day-indicator.leave {
        background: rgba(139, 92, 246, 0.2);
        color: var(--accent-purple);
    }

    .calendar-day-indicator.weekend {
        background: rgba(100, 116, 139, 0.1);
        color: var(--text-muted);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 80px 20px;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
    }

    .empty-state-icon {
        font-size: 80px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .empty-state-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 8px;
        color: var(--text-primary);
    }

    .empty-state-description {
        color: var(--text-secondary);
        font-size: 14px;
        margin-bottom: 24px;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .summary-cards {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .attendance-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .attendance-title {
            font-size: 24px;
        }

        .attendance-controls {
            width: 100%;
        }

        .filter-group {
            width: 100%;
        }

        .filter-select {
            flex: 1;
            min-width: 100px;
        }

        .summary-cards {
            grid-template-columns: 1fr;
        }

        .attendance-table {
            font-size: 12px;
        }

        .attendance-table th,
        .attendance-table td {
            padding: 12px 8px;
        }

        .time-cell {
            font-size: 11px;
        }

        .calendar tbody td {
            padding: 8px;
            min-height: 50px;
        }

        .calendar-day-number {
            font-size: 11px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper" style="padding: 32px 20px;">
    <!-- Page Header -->
    <div class="attendance-header">
        <div>
            <h1 class="attendance-title">My Attendance</h1>
            <p style="color: var(--text-secondary); margin-top: 8px;">
                Track your attendance and work hours history
            </p>
        </div>
        <div class="attendance-controls">
            <div class="filter-group">
                <!-- Month Selector -->
                <select class="filter-select" id="monthSelect" onchange="updateAttendance()">
                    <option value="1" {% if month|stringformat:"d" == "1" %}selected{% endif %}>January</option>
                    <option value="2" {% if month|stringformat:"d" == "2" %}selected{% endif %}>February</option>
                    <option value="3" {% if month|stringformat:"d" == "3" %}selected{% endif %}>March</option>
                    <option value="4" {% if month|stringformat:"d" == "4" %}selected{% endif %}>April</option>
                    <option value="5" {% if month|stringformat:"d" == "5" %}selected{% endif %}>May</option>
                    <option value="6" {% if month|stringformat:"d" == "6" %}selected{% endif %}>June</option>
                    <option value="7" {% if month|stringformat:"d" == "7" %}selected{% endif %}>July</option>
                    <option value="8" {% if month|stringformat:"d" == "8" %}selected{% endif %}>August</option>
                    <option value="9" {% if month|stringformat:"d" == "9" %}selected{% endif %}>September</option>
                    <option value="10" {% if month|stringformat:"d" == "10" %}selected{% endif %}>October</option>
                    <option value="11" {% if month|stringformat:"d" == "11" %}selected{% endif %}>November</option>
                    <option value="12" {% if month|stringformat:"d" == "12" %}selected{% endif %}>December</option>
                </select>

                <!-- Year Selector -->
                <select class="filter-select" id="yearSelect" onchange="updateAttendance()">
                    {% for y in years %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>

                <!-- View Toggle -->
                <div class="toggle-view">
                    <button class="toggle-btn active" id="tableViewBtn" onclick="switchView('table')">
                        <i class="bi bi-table"></i> Table
                    </button>
                    <button class="toggle-btn" id="calendarViewBtn" onclick="switchView('calendar')">
                        <i class="bi bi-calendar-week"></i> Calendar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    {% if attendances %}
    <div class="summary-cards">
        <div class="summary-card">
            <div class="summary-card-icon">‚úÖ</div>
            <div class="summary-card-label">Days Present</div>
            <div class="summary-card-value" id="presentCount">{{ present_count|default:"0" }}</div>
            <div class="summary-card-detail">Out of 22 working days</div>
        </div>

        <div class="summary-card">
            <div class="summary-card-icon">‚ùå</div>
            <div class="summary-card-label">Days Absent</div>
            <div class="summary-card-value" id="absentCount">{{ absent_count|default:"0" }}</div>
            <div class="summary-card-detail">Unexcused absences</div>
        </div>

        <div class="summary-card">
            <div class="summary-card-icon">‚è±Ô∏è</div>
            <div class="summary-card-label">Total Hours</div>
            <div class="summary-card-value" id="totalHours">{{ total_hours|default:"0" }}</div>
            <div class="summary-card-detail">This month</div>
        </div>

        <div class="summary-card">
            <div class="summary-card-icon">üìä</div>
            <div class="summary-card-label">Attendance Rate</div>
            <div class="summary-card-value" id="attendanceRate">{{ attendance_rate|default:"0" }}%</div>
            <div class="summary-card-detail">Monthly average</div>
        </div>
    </div>
    {% endif %}

    <!-- Table View -->
    {% if attendances %}
    <div class="attendance-table-container" id="tableView">
        <table class="attendance-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Day</th>
                    <th>Login Time</th>
                    <th>Logout Time</th>
                    <th>Work Hours</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for attendance in attendances %}
                <tr>
                    <td class="date-cell">
                        {{ attendance.date|date:"M d, Y" }}
                    </td>
                    <td>
                        {{ attendance.date|date:"l" }}
                    </td>
                    <td class="time-cell">
                        {% if attendance.login_time %}
                            {{ attendance.login_time|date:"H:i" }}
                        {% else %}
                            <span style="color: var(--text-muted);">--:--</span>
                        {% endif %}
                    </td>
                    <td class="time-cell">
                        {% if attendance.logout_time %}
                            {{ attendance.logout_time|date:"H:i" }}
                        {% else %}
                            <span style="color: var(--text-muted);">--:--</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if attendance.total_work_seconds %}
                            <span class="hours-badge">
                                {{ attendance.total_work_seconds|stringformat:"d"|add:"0"|divisibleby:"3600" }}
                                {% widthratio attendance.total_work_seconds 3600 1 %}h
                            </span>
                        {% else %}
                            <span class="hours-badge">0h</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if attendance.login_time and attendance.logout_time %}
                            <span class="status-badge present">
                                <i class="bi bi-check-circle-fill"></i> Present
                            </span>
                        {% elif attendance.login_time %}
                            <span class="status-badge half_day">
                                <i class="bi bi-dash-circle-fill"></i> Half Day
                            </span>
                        {% else %}
                            <span class="status-badge absent">
                                <i class="bi bi-x-circle-fill"></i> Absent
                            </span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px;">
                        <span style="color: var(--text-muted);">No attendance records for this period</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Calendar View -->
    <div class="calendar-container" id="calendarView">
        <div style="text-align: center; margin-bottom: 20px;">
            <h3 style="font-size: 18px; font-weight: 600; color: var(--text-primary);">
                {{ month|add:"0" }} / {{ year }}
            </h3>
        </div>
        <table class="calendar" id="attendanceCalendar">
            <thead>
                <tr>
                    <th>Sun</th>
                    <th>Mon</th>
                    <th>Tue</th>
                    <th>Wed</th>
                    <th>Thu</th>
                    <th>Fri</th>
                    <th>Sat</th>
                </tr>
            </thead>
            <tbody id="calendarBody">
                <!-- Generated by JavaScript -->
            </tbody>
        </table>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <div class="empty-state-icon">üìÖ</div>
        <h3 class="empty-state-title">No Attendance Records</h3>
        <p class="empty-state-description">
            No attendance records found for the selected month and year. Try selecting a different month.
        </p>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Attendance data from template
    const attendanceData = {
        {% for attendance in attendances %}
        '{{ attendance.date|date:"Y-m-d" }}': {
            login: '{{ attendance.login_time|date:"H:i"|default:"" }}',
            logout: '{{ attendance.logout_time|date:"H:i"|default:"" }}',
            hours: {{ attendance.total_work_seconds|default:"0" }},
            present: {% if attendance.login_time and attendance.logout_time %}true{% else %}false{% endif %}
        },
        {% endfor %}
    };

    // Get years for selector
    function getYearRange() {
        const currentYear = new Date().getFullYear();
        const years = [];
        for (let i = currentYear - 5; i <= currentYear + 2; i++) {
            years.push(i);
        }
        return years;
    }

    // Switch between table and calendar view
    function switchView(view) {
        const tableView = document.getElementById('tableView');
        const calendarView = document.getElementById('calendarView');
        const tableBtn = document.getElementById('tableViewBtn');
        const calendarBtn = document.getElementById('calendarViewBtn');

        if (view === 'table') {
            tableView.style.display = 'block';
            calendarView.classList.remove('active');
            tableBtn.classList.add('active');
            calendarBtn.classList.remove('active');
        } else {
            tableView.style.display = 'none';
            calendarView.classList.add('active');
            tableBtn.classList.remove('active');
            calendarBtn.classList.add('active');
            generateCalendar();
        }
    }

    // Generate calendar
    function generateCalendar() {
        const month = parseInt(document.getElementById('monthSelect').value);
        const year = parseInt(document.getElementById('yearSelect').value);
        const firstDay = new Date(year, month - 1, 1).getDay();
        const daysInMonth = new Date(year, month, 0).getDate();
        const calendarBody = document.getElementById('calendarBody');

        calendarBody.innerHTML = '';
        let date = 1;

        for (let i = 0; i < 6; i++) {
            const row = document.createElement('tr');

            for (let j = 0; j < 7; j++) {
                const cell = document.createElement('td');

                if (i === 0 && j < firstDay) {
                    cell.innerHTML = '';
                } else if (date > daysInMonth) {
                    cell.innerHTML = '';
                } else {
                    const dateStr = String(date).padStart(2, '0');
                    const fullDate = `${year}-${String(month).padStart(2, '0')}-${dateStr}`;
                    const attendance = attendanceData[fullDate];
                    const dayOfWeek = new Date(year, month - 1, date).getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                    let statusClass = 'weekend';
                    let statusText = 'Weekend';

                    if (attendance) {
                        if (attendance.present) {
                            statusClass = 'present';
                            statusText = 'Present';
                        } else {
                            statusClass = 'absent';
                            statusText = 'Absent';
                        }
                    }

                    cell.innerHTML = `
                        <span class="calendar-day-number">${date}</span>
                        ${attendance ? `<span class="calendar-day-indicator ${statusClass}">${statusText}</span>` : ''}
                    `;

                    date++;
                }

                row.appendChild(cell);
            }

            calendarBody.appendChild(row);
        }
    }

    // Update attendance with filters
    function updateAttendance() {
        const month = document.getElementById('monthSelect').value;
        const year = document.getElementById('yearSelect').value;
        
        const url = new URL(window.location);
        url.searchParams.set('month', month);
        url.searchParams.set('year', year);
        
        window.location.href = url.toString();
    }

    // Calculate and display summary stats
    function calculateStats() {
        let presentCount = 0;
        let absentCount = 0;
        let totalSeconds = 0;

        Object.values(attendanceData).forEach(record => {
            if (record.present) {
                presentCount++;
                totalSeconds += record.hours;
            } else if (record.login === '') {
                absentCount++;
            }
        });

        const totalHours = (totalSeconds / 3600).toFixed(1);
        const attendanceRate = Math.round((presentCount / 22) * 100);

        document.getElementById('presentCount').textContent = presentCount;
        document.getElementById('absentCount').textContent = absentCount;
        document.getElementById('totalHours').textContent = totalHours + 'h';
        document.getElementById('attendanceRate').textContent = attendanceRate + '%';
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        calculateStats();
        
        // Add year options dynamically if needed
        const years = getYearRange();
        // Years are already populated from template
    });
</script>
{% endblock %}
