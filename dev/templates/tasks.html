{% extends 'base.html' %}
{% load static %}

{% block title %}My Tasks - BThinkX{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dev/css/tasks.css' %}">
<style>
        .tasks-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .tasks-title {
        font-size: 32px;
        font-weight: 800;
        font-family: 'Space Grotesk', sans-serif;
        background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .tasks-controls {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-group {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .filter-select {
        padding: 10px 16px;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        color: var(--text-primary);
        font-family: 'Inter', sans-serif;
        cursor: pointer;
        transition: var(--transition);
        font-size: 14px;
        font-weight: 500;
    }

    .filter-select:hover {
        border-color: var(--accent-purple);
        background: rgba(139, 92, 246, 0.1);
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--accent-purple);
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
    }

    .reset-filters {
        padding: 10px 16px;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: var(--accent-red);
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
        font-weight: 500;
        font-size: 14px;
    }

    .reset-filters:hover {
        background: rgba(239, 68, 68, 0.2);
        border-color: var(--accent-red);
    }

    /* Tasks Container */
    .tasks-container {
        display: grid;
        gap: 16px;
    }

    /* Task Item */
    .task-item {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 20px;
        display: grid;
        grid-template-columns: auto 1fr auto auto;
        gap: 20px;
        align-items: center;
        transition: var(--transition);
        cursor: pointer;
    }

    .task-item:hover {
        border-color: var(--accent-purple);
        background: rgba(139, 92, 246, 0.05);
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(139, 92, 246, 0.15);
    }

    .task-checkbox {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        border: 2px solid var(--card-border);
        background: transparent;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    .task-checkbox:hover {
        border-color: var(--accent-purple);
    }

    .task-checkbox.checked {
        background: var(--accent-purple);
        border-color: var(--accent-purple);
        color: white;
    }

    .task-content {
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-width: 0;
    }

    .task-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        transition: color 0.2s;
        word-break: break-word;
    }

    .task-item:hover .task-title {
        color: var(--accent-purple);
    }

    .task-meta {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        font-size: 13px;
        color: var(--text-secondary);
    }

    .task-meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .task-meta-item i {
        opacity: 0.7;
    }

    .task-description {
        font-size: 13px;
        color: var(--text-secondary);
        margin-top: 8px;
        line-height: 1.4;
        word-break: break-word;
    }

    /* Task Details */
    .task-details {
        display: flex;
        gap: 16px;
        align-items: center;
        justify-content: flex-end;
    }

    /* Status Badge */
    .status-badge {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        text-transform: capitalize;
        display: inline-block;
        white-space: nowrap;
    }

    .status-badge.todo {
        background: rgba(226, 232, 240, 0.1);
        color: var(--text-secondary);
        border: 1px solid rgba(226, 232, 240, 0.2);
    }

    .status-badge.in_progress {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent-blue);
        border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .status-badge.done {
        background: rgba(16, 185, 129, 0.1);
        color: var(--accent-green);
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    /* Priority Badge */
    .priority-badge {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        text-transform: capitalize;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }

    .priority-badge.low {
        background: rgba(16, 185, 129, 0.1);
        color: var(--accent-green);
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .priority-badge.medium {
        background: rgba(245, 158, 11, 0.1);
        color: var(--accent-yellow);
        border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .priority-badge.high {
        background: rgba(239, 68, 68, 0.1);
        color: var(--accent-red);
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .priority-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .empty-state-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-primary);
    }

    .empty-state-description {
        color: var(--text-secondary);
        font-size: 14px;
        margin-bottom: 24px;
    }

    .empty-state-action {
        padding: 10px 20px;
        background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
    }

    .empty-state-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(139, 92, 246, 0.4);
    }

    /* Stats Bar */
    .stats-bar {
        display: flex;
        gap: 20px;
        margin-bottom: 32px;
        flex-wrap: wrap;
    }

    .stat-card-mini {
        flex: 1;
        min-width: 150px;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: var(--transition);
    }

    .stat-card-mini:hover {
        border-color: var(--accent-purple);
        background: rgba(139, 92, 246, 0.05);
    }

    .stat-card-mini-icon {
        font-size: 24px;
        opacity: 0.8;
    }

    .stat-card-mini-content {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .stat-card-mini-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    .stat-card-mini-value {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
    }

    /* Pagination */
    .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-top: 40px;
        flex-wrap: wrap;
    }

    .pagination-item {
        padding: 8px 12px;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 6px;
        color: var(--text-primary);
        cursor: pointer;
        transition: var(--transition);
        font-size: 14px;
        font-weight: 500;
    }

    .pagination-item:hover {
        border-color: var(--accent-purple);
        background: rgba(139, 92, 246, 0.1);
    }

    .pagination-item.active {
        background: var(--accent-purple);
        border-color: var(--accent-purple);
        color: white;
    }

    .pagination-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .task-item {
            grid-template-columns: auto 1fr;
            gap: 16px;
        }

        .task-details {
            grid-column: 2;
            justify-content: flex-start;
        }
    }

    @media (max-width: 768px) {
        .tasks-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .tasks-title {
            font-size: 24px;
        }

        .tasks-controls {
            width: 100%;
        }

        .filter-group {
            width: 100%;
        }

        .filter-select {
            flex: 1;
            min-width: 120px;
        }

        .task-item {
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .task-details {
            grid-column: 1;
            justify-content: space-between;
            border-top: 1px solid var(--card-border);
            padding-top: 12px;
            margin-top: 12px;
        }

        .stat-card-mini {
            flex: 1;
            min-width: 120px;
        }
    }

</style>
{% endblock %}

{% block content %}
<div class="content-wrapper" style="padding: 32px 20px;">
    <!-- Page Header -->
    <div class="tasks-header">
        <div>
            <h1 class="tasks-title">My Tasks</h1>
            <p style="color: var(--text-secondary); margin-top: 8px;">
                Manage and track your assigned tasks
            </p>
        </div>
        <div class="tasks-controls">
            <div class="filter-group">
                <!-- Status Filter -->
                <select class="filter-select" id="statusFilter" onchange="filterTasks()">
                    <option value="">Status: All</option>
                    <option value="todo" {% if status_filter == 'todo' %}selected{% endif %}>To Do</option>
                    <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>In Progress</option>
                    <option value="done" {% if status_filter == 'done' %}selected{% endif %}>Done</option>
                </select>

                <!-- Priority Filter -->
                <select class="filter-select" id="priorityFilter" onchange="filterTasks()">
                    <option value="">Priority: All</option>
                    <option value="low" {% if priority_filter == 'low' %}selected{% endif %}>Low</option>
                    <option value="medium" {% if priority_filter == 'medium' %}selected{% endif %}>Medium</option>
                    <option value="high" {% if priority_filter == 'high' %}selected{% endif %}>High</option>
                </select>

                <!-- Reset Button -->
                {% if status_filter != 'all' or priority_filter != 'all' %}
                <button class="reset-filters" onclick="resetFilters()">
                    <i class="bi bi-arrow-clockwise"></i> Reset
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Stats Bar -->
    {% if page_obj.paginator.count > 0 %}
    <div class="stats-bar">
        <div class="stat-card-mini">
            <div class="stat-card-mini-icon">üìã</div>
            <div class="stat-card-mini-content">
                <div class="stat-card-mini-label">Total Tasks</div>
                <div class="stat-card-mini-value">{{ page_obj.paginator.count }}</div>
            </div>
        </div>
        <div class="stat-card-mini">
            <div class="stat-card-mini-icon">‚è≥</div>
            <div class="stat-card-mini-content">
                <div class="stat-card-mini-label">Showing</div>
                <div class="stat-card-mini-value">{{ page_obj.object_list|length }}</div>
            </div>
        </div>
        <div class="stat-card-mini">
            <div class="stat-card-mini-icon">üìÑ</div>
            <div class="stat-card-mini-content">
                <div class="stat-card-mini-label">Page</div>
                <div class="stat-card-mini-value">{{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Tasks List -->
    <div class="tasks-container">
        {% if page_obj.object_list %}
            {% for task in page_obj.object_list %}
            <div class="task-item" data-task-id="{{ task.id }}">
                <!-- Checkbox -->
                <div class="task-checkbox" onclick="toggleTask({{ task.id }})">
                    {% if task.status == 'done' %}
                    <i class="bi bi-check" style="color: white;"></i>
                    {% endif %}
                </div>

                <!-- Task Content -->
                <div class="task-content">
                    <div class="task-title">{{ task.title }}</div>
                    <div class="task-meta">
                        {% if task.project %}
                        <div class="task-meta-item">
                            <i class="bi bi-folder"></i>
                            <span>{{ task.project.name }}</span>
                        </div>
                        {% endif %}
                        
                        {% if task.due_date %}
                        <div class="task-meta-item">
                            <i class="bi bi-calendar"></i>
                            <span>{{ task.due_date|date:"M d, Y" }}</span>
                        </div>
                        {% endif %}
                        
                        {% if task.assignee %}
                        <div class="task-meta-item">
                            <i class="bi bi-person"></i>
                            <span>{{ task.assignee.get_full_name }}</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if task.description %}
                    <div class="task-description">{{ task.description|truncatewords:20 }}</div>
                    {% endif %}
                </div>

                <!-- Task Details (Status & Priority) -->
                <div class="task-details">
                    <!-- Status Badge -->
                    <span class="status-badge {{ task.status }}">
                        {% if task.status == 'todo' %}
                            <i class="bi bi-circle"></i> To Do
                        {% elif task.status == 'in_progress' %}
                            <i class="bi bi-arrow-repeat"></i> In Progress
                        {% elif task.status == 'done' %}
                            <i class="bi bi-check-circle-fill"></i> Done
                        {% endif %}
                    </span>

                    <!-- Priority Badge -->
                    <span class="priority-badge {{ task.priority }}">
                        <span class="priority-dot"></span>
                        {% if task.priority == 'low' %}Low
                        {% elif task.priority == 'medium' %}Medium
                        {% elif task.priority == 'high' %}High
                        {% endif %}
                    </span>
                </div>

                <!-- Task Actions (Hidden on Mobile) -->
                <div style="display: flex; gap: 8px; align-items: center;">
                    <a href="javascript:void(0);" class="task-action-btn" title="View Task" onclick="viewTask({{ task.id }})" style="padding: 8px 12px; background: rgba(139, 92, 246, 0.1); color: var(--accent-purple); border: none; border-radius: 6px; cursor: pointer; transition: var(--transition); font-size: 14px; font-weight: 500;">
                        <i class="bi bi-eye"></i>
                    </a>
                    <a href="javascript:void(0);" class="task-action-btn" title="Edit Task" onclick="editTask({{ task.id }})" style="padding: 8px 12px; background: rgba(59, 130, 246, 0.1); color: var(--accent-blue); border: none; border-radius: 6px; cursor: pointer; transition: var(--transition); font-size: 14px; font-weight: 500;">
                        <i class="bi bi-pencil"></i>
                    </a>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <!-- Empty State -->
            <div class="empty-state">
                <div class="empty-state-icon">üìù</div>
                <h3 class="empty-state-title">No Tasks Found</h3>
                <p class="empty-state-description">
                    {% if status_filter != 'all' or priority_filter != 'all' %}
                        No tasks match your current filters. Try adjusting them.
                    {% else %}
                        You don't have any assigned tasks yet. Check back later!
                    {% endif %}
                </p>
                {% if status_filter != 'all' or priority_filter != 'all' %}
                <button class="empty-state-action" onclick="resetFilters()">
                    <i class="bi bi-arrow-clockwise"></i> Reset Filters
                </button>
                {% endif %}
            </div>
        {% endif %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="pagination-container">
        <!-- Previous -->
        {% if page_obj.has_previous %}
        <a href="?page=1{% if status_filter != 'all' %}&status={{ status_filter }}{% endif %}{% if priority_filter != 'all' %}&priority={{ priority_filter }}{% endif %}" class="pagination-item">
            <i class="bi bi-chevron-double-left"></i>
        </a>
        <a href="?page={{ page_obj.previous_page_number }}{% if status_filter != 'all' %}&status={{ status_filter }}{% endif %}{% if priority_filter != 'all' %}&priority={{ priority_filter }}{% endif %}" class="pagination-item">
            <i class="bi bi-chevron-left"></i> Prev
        </a>
        {% else %}
        <span class="pagination-item disabled">
            <i class="bi bi-chevron-double-left"></i>
        </span>
        <span class="pagination-item disabled">
            <i class="bi bi-chevron-left"></i> Prev
        </span>
        {% endif %}

        <!-- Page Numbers -->
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <span class="pagination-item active">{{ num }}</span>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <a href="?page={{ num }}{% if status_filter != 'all' %}&status={{ status_filter }}{% endif %}{% if priority_filter != 'all' %}&priority={{ priority_filter }}{% endif %}" class="pagination-item">{{ num }}</a>
            {% endif %}
        {% endfor %}

        <!-- Next -->
        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if status_filter != 'all' %}&status={{ status_filter }}{% endif %}{% if priority_filter != 'all' %}&priority={{ priority_filter }}{% endif %}" class="pagination-item">
            Next <i class="bi bi-chevron-right"></i>
        </a>
        <a href="?page={{ page_obj.paginator.num_pages }}{% if status_filter != 'all' %}&status={{ status_filter }}{% endif %}{% if priority_filter != 'all' %}&priority={{ priority_filter }}{% endif %}" class="pagination-item">
            <i class="bi bi-chevron-double-right"></i>
        </a>
        {% else %}
        <span class="pagination-item disabled">
            Next <i class="bi bi-chevron-right"></i>
        </span>
        <span class="pagination-item disabled">
            <i class="bi bi-chevron-double-right"></i>
        </span>
        {% endif %}
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Filter Tasks
    function filterTasks() {
        const status = document.getElementById('statusFilter').value;
        const priority = document.getElementById('priorityFilter').value;
        
        let url = '?';
        if (status) url += `status=${status}&`;
        if (priority) url += `priority=${priority}&`;
        
        window.location.href = url;
    }

    // Reset Filters
    function resetFilters() {
        window.location.href = '?';
    }

    // Toggle Task Completion
    function toggleTask(taskId) {
        const taskItem = document.querySelector(`[data-task-id="${taskId}"]`);
        const checkbox = taskItem.querySelector('.task-checkbox');
        
        checkbox.classList.toggle('checked');
        
        // Here you would make an AJAX request to update the task status
        // fetch(`/api/tasks/${taskId}/toggle/`, { method: 'POST' })
        //     .then(response => response.json())
        //     .then(data => console.log('Task updated:', data));
    }

    // View Task Details
    function viewTask(taskId) {
        // Redirect to task detail page or open modal
        // window.location.href = `/tasks/${taskId}/`;
        alert(`View task ${taskId}`);
    }

    // Edit Task
    function editTask(taskId) {
        // Redirect to edit page or open modal
        // window.location.href = `/tasks/${taskId}/edit/`;
        alert(`Edit task ${taskId}`);
    }

    // Restore filter selections on page load
    document.addEventListener('DOMContentLoaded', function() {
        const params = new URLSearchParams(window.location.search);
        const status = params.get('status');
        const priority = params.get('priority');
        
        if (status) {
            document.getElementById('statusFilter').value = status;
        }
        if (priority) {
            document.getElementById('priorityFilter').value = priority;
        }
    });

    // Add hover effects to task items
    document.querySelectorAll('.task-item').forEach(item => {
        item.addEventListener('mouseenter', function() {
            this.style.borderColor = 'var(--accent-purple)';
        });
        item.addEventListener('mouseleave', function() {
            this.style.borderColor = 'var(--card-border)';
        });
    });
</script>
{% endblock %}
